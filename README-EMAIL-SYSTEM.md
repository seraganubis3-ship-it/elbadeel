# نظام البريد الإلكتروني - منصة البديل

## نظرة عامة

تم إنشاء نظام شامل لإدارة البريد الإلكتروني في منصة البديل، يتضمن:

1. **تأكيد البريد الإلكتروني** - عند التسجيل
2. **إعادة تعيين كلمة المرور** - عند نسيان كلمة المرور
3. **إعادة إرسال رسالة التأكيد** - عند الحاجة

## الملفات المُنشأة

### الصفحات
- `/forgot-password` - صفحة نسيان كلمة المرور
- `/reset-password` - صفحة إعادة تعيين كلمة المرور
- `/verify-email` - صفحة تأكيد البريد الإلكتروني

### API Routes
- `/api/auth/forgot-password` - إرسال رابط إعادة تعيين كلمة المرور
- `/api/auth/reset-password` - إعادة تعيين كلمة المرور
- `/api/auth/resend-verification` - إعادة إرسال رسالة التأكيد
- `/api/auth/verify-email` - تأكيد البريد الإلكتروني

### المكتبات
- `/lib/email.ts` - مكتبة إرسال البريد الإلكتروني

## كيفية الإعداد

### 1. تثبيت المكتبات المطلوبة

```bash
npm install nodemailer
npm install @types/nodemailer --save-dev
```

### 2. إعداد متغيرات البيئة

أضف المتغيرات التالية إلى ملف `.env.local`:

```env
# SMTP Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

# NextAuth Configuration
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key
```

### 3. تحديث قاعدة البيانات

قم بتشغيل الأمر التالي لتحديث قاعدة البيانات:

```bash
npx prisma db push
```

## كيفية العمل

### 1. تأكيد البريد الإلكتروني

1. المستخدم يسجل حساب جديد
2. يتم إرسال رسالة تأكيد تلقائياً
3. المستخدم يضغط على رابط التأكيد
4. يتم تأكيد الحساب

### 2. إعادة تعيين كلمة المرور

1. المستخدم يضغط على "نسيت كلمة المرور"
2. يدخل بريده الإلكتروني
3. يتم إرسال رابط إعادة التعيين
4. المستخدم يضغط على الرابط ويضع كلمة مرور جديدة

### 3. إعادة إرسال رسالة التأكيد

1. المستخدم يذهب إلى صفحة تأكيد البريد الإلكتروني
2. يدخل بريده الإلكتروني
3. يتم إرسال رسالة تأكيد جديدة

## ميزات الأمان

- **توكنات مؤقتة**: جميع التوكنات تنتهي صلاحيتها تلقائياً
- **تشفير كلمات المرور**: استخدام bcrypt مع salt
- **عدم كشف المعلومات**: لا يتم كشف ما إذا كان البريد الإلكتروني مسجل أم لا
- **حماية من CSRF**: استخدام توكنات CSRF في النماذج

## أوقات انتهاء الصلاحية

- **رسائل التأكيد**: 24 ساعة
- **روابط إعادة تعيين كلمة المرور**: 1 ساعة

## الوضع التجريبي

في وضع التطوير، يتم طباعة رسائل البريد الإلكتروني في console بدلاً من إرسالها فعلياً. هذا مفيد للاختبار بدون إعداد SMTP.

## استكشاف الأخطاء

### مشاكل شائعة

1. **خطأ في إرسال البريد الإلكتروني**
   - تأكد من صحة بيانات SMTP
   - تحقق من إعدادات Gmail (إذا كنت تستخدم Gmail)

2. **التوكنات لا تعمل**
   - تأكد من صحة `NEXTAUTH_URL`
   - تحقق من أن التوكن لم ينتهي صلاحيته

3. **مشاكل في قاعدة البيانات**
   - تأكد من تشغيل `npx prisma db push`
   - تحقق من وجود الحقول المطلوبة في نموذج User

### رسائل الخطأ

- `EMAIL_NOT_VERIFIED` - البريد الإلكتروني غير مؤكد
- `TOKEN_EXPIRED` - التوكن منتهي الصلاحية
- `INVALID_TOKEN` - التوكن غير صحيح

## الدعم

إذا واجهت أي مشاكل، تأكد من:

1. صحة إعدادات SMTP
2. تحديث قاعدة البيانات
3. صحة متغيرات البيئة
4. تشغيل الخادم في الوضع الصحيح

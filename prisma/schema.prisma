generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id                      String       @id @default(cuid())
  name                    String?
  email                   String?      @unique
  emailVerified           DateTime?
  image                   String?
  passwordHash            String?
  phone                   String?
  additionalPhone         String?
  role                    String       @default("USER")
  createdByAdminId        String?
  createdByAdmin          User?        @relation("UserCreatedByAdmin", fields: [createdByAdminId], references: [id])
  createdUsers            User[]       @relation("UserCreatedByAdmin")
  createdOrders           Order[]      @relation("OrderCreatedByAdmin")
  orders                  Order[]      @relation("OrderUser")
  resetToken              String?
  resetTokenExpiry        DateTime?
  verificationToken       String?
  verificationTokenExpiry DateTime?
  verificationCode        String?
  verificationCodeExpiry  DateTime?
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt
  address                 String?
  governorate             String?
  city                    String?
  district                String?
  street                  String?
  buildingNumber          String?
  apartmentNumber         String?
  landmark                String?
  birthDate               DateTime?
  fatherName              String?
  idNumber                String?
  motherName              String?
  nationality             String?
  gender                  String?
  wifeName                String?
  wifeMotherName          String?
  accounts                Account[]
  auditLogs               AuditLog[]
  sessions                Session[]
  addedFormSerials        FormSerial[] @relation("FormSerialAddedBy")
  consumedFormSerials     FormSerial[] @relation("FormSerialConsumedBy")
  createdDependents       Dependent[]  @relation("DependentCreatedBy")

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@index([resetToken])
  @@index([verificationToken])
  @@index([verificationCode])
  @@index([idNumber])
  @@index([name])
  @@index([createdByAdminId])
}

model Category {
  id         String    @id @default(cuid())
  name       String
  slug       String    @unique
  orderIndex Int       @default(0)
  active     Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  icon       String?
  services   Service[]

  @@index([slug])
  @@index([orderIndex])
  @@index([active])
}

model Service {
  id          String            @id @default(cuid())
  name        String
  slug        String            @unique
  description String?
  icon        String?
  active      Boolean           @default(true)
  isHidden    Boolean           @default(false)
  orderIndex  Int               @default(0)
  categoryId  String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  orders      Order[]
  category    Category          @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  documents   ServiceDocument[]
  variants    ServiceVariant[]
  fields      ServiceField[]

  @@index([slug])
  @@index([categoryId])
  @@index([active])
  @@index([orderIndex])
  @@index([createdAt])
}

model ServiceField {
  id          String  @id @default(cuid())
  serviceId   String
  name        String
  label       String
  type        String
  placeholder String?
  required    Boolean @default(false)
  orderIndex  Int     @default(0)
  active      Boolean @default(true)
  showIf      String?
  validation  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  service Service              @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  options ServiceFieldOption[]

  @@index([serviceId])
  @@index([orderIndex])
  @@index([active])
}

model ServiceFieldOption {
  id         String @id @default(cuid())
  fieldId    String
  value      String
  label      String
  orderIndex Int    @default(0)
  requiredDocs String?
  showFields String?
  createdAt DateTime @default(now())

  field ServiceField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@index([fieldId])
  @@index([orderIndex])
}

model ServiceVariant {
  id            String            @id @default(cuid())
  name          String
  priceCents    Int
  etaDays       Int
  serviceId     String
  active        Boolean           @default(true)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  orders        Order[]
  service       Service           @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  formTypeLinks FormTypeVariant[]

  @@index([serviceId])
  @@index([priceCents])
  @@index([active])
}

model Order {
  id                      String          @id @default(cuid())
  userId                  String
  serviceId               String
  variantId               String
  status                  String          @default("PENDING")
  totalPrice              Int
  totalCents              Int
  customerName            String
  customerPhone           String
  additionalPhone         String?
  customerEmail           String
  address                 String?
  governorate             String?
  city                    String?
  district                String?
  street                  String?
  buildingNumber          String?
  apartmentNumber         String?
  landmark                String?
  notes                   String?
  adminNotes              String?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  completedAt             DateTime?
  estimatedCompletionDate DateTime?
  deliveryFee             Int             @default(0)
  deliveryType            String          @default("OFFICE")
  createdByAdminId        String?
  createdByAdmin          User?           @relation("OrderCreatedByAdmin", fields: [createdByAdminId], references: [id])
  birthDate               DateTime?
  fatherName              String?
  idNumber                String?
  motherName              String?
  nationality             String?
  wifeName                String?
  photographyLocation     String?
  photographyDate         DateTime?
  marriageDate            DateTime?
  divorceDate             DateTime?
  deathDate               DateTime?
  wifeMotherName          String?
  quantity                Int             @default(1)
  serviceDetails          String?
  otherFees               Int             @default(0)
  discount                Int             @default(0)
  gender                  String?
  policeStation           String?
  pickupLocation          String?
  originalDocuments       String?
  attachedDocuments       String?
  workOrderNumber         Int?
  hasAttachments          Boolean         @default(false)
  selectedFines           String?
  finesDetails            String?
  servicesDetails         String?
  customerFollowUp        String?
  destination             String?
  title                   String?
  documents               Document[]
  service                 Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  user                    User            @relation("OrderUser", fields: [userId], references: [id], onDelete: Cascade)
  variant                 ServiceVariant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  orderDocuments          OrderDocument[]
  payment                 Payment?
  formSerials             FormSerial[]
  promoCodeId    String?
  promoCode      PromoCode? @relation(fields: [promoCodeId], references: [id])
  discountAmount Int        @default(0)

  @@index([userId])
  @@index([serviceId])
  @@index([variantId])
  @@index([status])
  @@index([createdAt])
  @@index([completedAt])
  @@index([deliveryType])
  @@index([idNumber])
  @@index([createdByAdminId])
  @@index([customerPhone])
  @@index([promoCodeId])
}

model Payment {
  id                String   @id @default(cuid())
  orderId           String   @unique
  amount            Int
  currency          String   @default("EGP")
  method            String
  status            String   @default("PENDING")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  paymentScreenshot String?
  senderPhone       String?
  notes             String?
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([senderPhone])
  @@index([status])
  @@index([createdAt])
  @@index([method])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  oldValues  String?
  newValues  String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}

model FAQ {
  id         String   @id @default(cuid())
  question   String   @unique
  answer     String
  orderIndex Int      @default(0)
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([orderIndex])
  @@index([active])
}

model Document {
  id         String   @id @default(cuid())
  orderId    String
  fileName   String
  filePath   String
  fileType   String
  fileSize   Int
  uploadedAt DateTime @default(now())
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([uploadedAt])
}

model OrderDocument {
  id           String   @id @default(cuid())
  orderId      String
  fileName     String
  filePath     String
  fileSize     Int
  fileType     String
  documentType String
  uploadedAt   DateTime @default(now())
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([uploadedAt])
  @@index([documentType])
}

model ServiceDocument {
  id          String   @id @default(cuid())
  serviceId   String
  title       String
  description String?
  required    Boolean  @default(true)
  showIf      String?
  orderIndex  Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([orderIndex])
  @@index([active])
}

model SystemSettings {
  id                 String   @id @default("main")
  siteName           String   @default("البديل")
  siteDescription    String?
  contactEmail       String?
  contactPhone       String?
  additionalPhone    String?
  whatsappPhone      String?
  secondaryWhatsappPhone String?
  address            String?
  workingHours       String?
  socialLinks        String?
  seoSettings        String?
  
  // New Fields
  defaultDeliveryFee Int      @default(0)
  paymentNumbers     String?  // Text area for transfer numbers
  facebookUrl        String?
  instagramUrl       String?
  logoUrl            String?
  tiktokUrl          String?
  twitterUrl         String?
  linkedinUrl        String?
  complaintsPhone    String?  @default("01001544258")
  
  updatedAt          DateTime @updatedAt
}

model FormType {
  id           String            @id @default(cuid())
  name         String            @unique
  description  String?
  active       Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  variantLinks FormTypeVariant[]
  serials      FormSerial[]

  @@index([active])
}

model FormTypeVariant {
  id               String         @id @default(cuid())
  formTypeId       String
  serviceVariantId String
  createdAt        DateTime       @default(now())
  formType         FormType       @relation(fields: [formTypeId], references: [id], onDelete: Cascade)
  serviceVariant   ServiceVariant @relation(fields: [serviceVariantId], references: [id], onDelete: Cascade)

  @@unique([formTypeId, serviceVariantId])
  @@index([formTypeId])
  @@index([serviceVariantId])
}

model FormSerial {
  id                String    @id @default(cuid())
  formTypeId        String
  serialNumber      String
  orderId           String?
  consumed          Boolean   @default(false)
  consumedAt        DateTime?
  addedByAdminId    String?
  consumedByAdminId String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  formType          FormType  @relation(fields: [formTypeId], references: [id], onDelete: Cascade)
  order             Order?    @relation(fields: [orderId], references: [id])
  addedByAdmin      User?     @relation("FormSerialAddedBy", fields: [addedByAdminId], references: [id])
  consumedByAdmin   User?     @relation("FormSerialConsumedBy", fields: [consumedByAdminId], references: [id])

  @@unique([formTypeId, serialNumber])
  @@index([formTypeId])
  @@index([orderId])
  @@index([consumed])
  @@index([addedByAdminId])
  @@index([consumedByAdminId])
}

model Dependent {
  id               String   @id @default(cuid())
  name             String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdByAdminId String?
  createdByAdmin   User?    @relation("DependentCreatedBy", fields: [createdByAdminId], references: [id])

  @@index([name])
  @@index([createdByAdminId])
}

model PromoCode {
  id             String    @id @default(cuid())
  code           String    @unique
  type           String    @default("FIXED")
  value          Int
  minOrderAmount Int?
  maxDiscount    Int?
  startDate      DateTime?
  endDate        DateTime?
  usageLimit     Int?
  usageLimitPerUser Int?
  currentUsage   Int       @default(0)
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  orders         Order[]

  @@index([code])
  @@index([isActive])
}

model Delegate {
  id             String   @id @default(cuid())
  name           String
  idNumber       String
  licenseNumber  String?
  idCardFront    String?
  idCardBack     String?
  unionCardFront String?
  unionCardBack  String?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([active])
}

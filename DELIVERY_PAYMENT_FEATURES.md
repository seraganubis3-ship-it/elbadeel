# ميزات التوصيل والدفع الجديدة

## نظرة عامة
تم إضافة ميزات جديدة لنظام الطلبات تشمل خيارات التوصيل وأنظمة الدفع الإلكتروني مع نظام إلغاء تلقائي للطلبات.

## الميزات المضافة

### 1. خيارات التوصيل
- **استلام من المكتب**: مجاناً
- **توصيل على العنوان**: رسوم إضافية 50 جنيه

### 2. أنظمة الدفع
- **فودافون كاش**: دفع عبر فودافون كاش
- **انستا باي**: دفع عبر انستا باي
- **أرقام الدفع**: عرض مباشر لأرقام الدفع في الواجهة

### 3. عملية الدفع
- إدخال رقم الهاتف المحول منه
- رفع سكرين شوت للتحويل
- تحديث حالة الطلب تلقائياً
- **مهلة الدفع**: 30 دقيقة قبل الإلغاء التلقائي

### 4. الإلغاء التلقائي
- إلغاء الطلبات التي لم يتم دفعها خلال 30 دقيقة
- تحديث حالة الطلب والدفع تلقائياً
- إضافة ملاحظات توضح سبب الإلغاء

## التحديثات التقنية

### قاعدة البيانات
تم تحديث `schema.prisma` بإضافة:
- `deliveryType` و `deliveryFee` في نموذج `Order`
- `senderPhone` و `paymentScreenshot` في نموذج `Payment`
- `notes` في نموذج `Payment` لتتبع سبب الإلغاء

### الواجهات
- تحديث `OrderForm` لإضافة خطوة التوصيل
- إنشاء صفحة الدفع `PaymentForm` مع عرض أرقام الدفع مباشرة
- تحديث صفحة الطلبات لعرض معلومات التوصيل والدفع
- عرض الوقت المتبقي للدفع مع تنبيهات

### API
- تحديث `/api/orders` لإرجاع بيانات التوصيل
- إنشاء `/api/orders/[id]/payment` لمعالجة الدفع
- إنشاء `/api/upload` لرفع سكرين شوت الدفع
- إنشاء `/api/cron/auto-cancel-orders` للإلغاء التلقائي

### Cron Jobs
- script لإلغاء الطلبات تلقائياً (`scripts/auto-cancel-orders.js`)
- يمكن تشغيله كل 5 دقائق من cron job
- دعم الإشعارات عند حدوث أخطاء

## كيفية الاستخدام

### 1. إنشاء طلب جديد
1. اختيار نوع الخدمة
2. إدخال معلومات العميل
3. رفع المستندات المطلوبة
4. اختيار طريقة التوصيل
5. مراجعة الطلب والتأكيد

### 2. إتمام الدفع
1. اختيار طريقة الدفع (فودافون كاش أو انستا باي)
2. رؤية رقم الدفع مباشرة في الواجهة
3. إدخال رقم الهاتف المحول منه
4. رفع سكرين شوت التحويل (اختياري)
5. إرسال بيانات الدفع
6. **⚠️ تنبيه: يجب إتمام الدفع خلال 30 دقيقة**

### 3. متابعة الطلب
- عرض حالة الطلب (في انتظار الدفع، في انتظار تأكيد الدفع، إلخ)
- عرض معلومات التوصيل والرسوم
- عرض تفاصيل الدفع
- **عرض الوقت المتبقي للدفع مع تنبيهات**

### 4. الإلغاء التلقائي
- يتم تشغيل cron job كل 5 دقائق
- البحث عن الطلبات التي لم يتم دفعها خلال 30 دقيقة
- إلغاء الطلبات تلقائياً وتحديث الحالة
- إضافة ملاحظات توضح سبب الإلغاء

## حالات الطلب
- `PENDING`: في انتظار الدفع (مهلة 30 دقيقة)
- `PAYMENT_PENDING`: في انتظار تأكيد الدفع
- `REVIEWING`: قيد المراجعة
- `PROCESSING`: قيد التنفيذ
- `COMPLETED`: مكتمل
- `CANCELLED`: ملغي (تلقائياً أو يدوياً)

## إعداد Cron Job

### 1. إنشاء ملف crontab
```bash
# تشغيل كل 5 دقائق
*/5 * * * * cd /path/to/your/project && node scripts/auto-cancel-orders.js >> logs/cron.log 2>&1
```

### 2. إعداد المتغيرات البيئية
```bash
CRON_API_KEY=your-secret-key-here
API_URL=https://yourdomain.com
```

### 3. اختبار الـ API
```bash
curl -H "x-api-key: your-secret-key" https://yourdomain.com/api/cron/auto-cancel-orders
```

## أرقام الدفع
- **فودافون كاش**: 01012345678
- **انستا باي**: 01087654321

> **ملاحظة**: يمكن تغيير هذه الأرقام في ملف `PaymentForm.tsx`

## ملاحظات مهمة
- رسوم التوصيل تُضاف تلقائياً عند اختيار التوصيل على العنوان
- يجب إدخال رقم الهاتف المحول منه عند الدفع
- يمكن رفع سكرين شوت التحويل كصورة أو ملف PDF
- يتم تحديث حالة الطلب تلقائياً عند إرسال بيانات الدفع
- **الطلبات التي لم يتم دفعها خلال 30 دقيقة تُلغى تلقائياً**
- يتم عرض الوقت المتبقي للدفع مع تنبيهات عند اقتراب انتهاء المهلة

## الدعم
لأي استفسارات أو مشاكل، يرجى التواصل مع فريق الدعم.
